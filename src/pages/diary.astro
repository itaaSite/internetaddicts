---
import { getCollection } from "astro:content"
import { getEntry } from "astro:content"
import Layout from "../layout/Layout.astro"
const diary = await getCollection("diary")

const sortedDiary = diary.sort((a, b) =>
							new Date(b.data.when).getTime() - new Date(a.data.when).getTime(),
					).reverse()
const currentDate = new Date()
const currentDay = currentDate.getDay() + 5

const diary1 = sortedDiary.find( (a) =>
    // TODO: когда ежедневник станет больше, переделать на проверку с месяцем
    new Date(a.data.when).getDay() === currentDay
)
var currentDiary
if (diary1 === undefined) {
  // TODO
  currentDiary = sortedDiary.at(0)
} else {
  currentDiary = diary1
}

const diaryDate = new Date(currentDiary.data.when)

const dateOptions: object = {
	day: "numeric",
	month: "long",
}
const formattedDate = diaryDate.toLocaleDateString("ru-RU", dateOptions)

const entry = await getEntry("diary", currentDiary.slug)
// 3. Redirect if the entry does not exist
if (entry === undefined) {
  return Astro.redirect("/404")
}
// 4. (Optional) Render the entry to HTML in the template
const { Content } = await entry.render();

---

<Layout
	title="Ежедневник"
	desc="Ежедневник АИЗ"
>
  <main class="p-5">
    <main
      class="mx-auto max-w-[780px] prose lg:prose-lg xl:prose-xl md:prose-md prose-p:text-slate-900 prose-a:text-blue-500 prose-headings:leading-tight prose-p:leading-relaxed prose-a:no-underline prose-zinc bg-white md:p-10 p-5 rounded-2xl"
    >
      <h1>Ежедневник АИЗ</h1>
      <h3>{formattedDate}</h3>

      <h4>{currentDiary.data.title}</h4>
      {currentDay}
      {new Date(currentDiary.data.when).getDay()}
      <Content />
    </main>
  </main>
</Layout>
