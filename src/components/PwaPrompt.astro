<div
	id="pwa-install-banner"
	class="fixed bottom-4 left-1/2 z-[70] hidden w-[calc(100%-24px)] max-w-md -translate-x-1/2 rounded-2xl border border-zinc-200 bg-white/95 p-3 shadow-xl backdrop-blur"
	aria-live="polite"
>
	<div class="flex items-start gap-3">
		<div class="mt-0.5 h-2.5 w-2.5 rounded-full bg-[#0071e3]"></div>
		<div class="min-w-0 flex-1">
			<p class="text-sm font-semibold text-zinc-900">Установить приложение АИЗ?</p>
			<p class="mt-1 text-xs text-zinc-600">
				Быстрый доступ с домашнего экрана и работа в отдельном окне.
			</p>
		</div>
	</div>
	<div class="mt-3 flex items-center justify-end gap-2">
		<button
			id="pwa-later"
			type="button"
			class="rounded-lg border border-zinc-300 bg-white px-3 py-1.5 text-xs font-medium text-zinc-700"
		>
			Позже
		</button>
		<button
			id="pwa-install"
			type="button"
			class="rounded-lg bg-[#0071e3] px-3 py-1.5 text-xs font-semibold text-white"
		>
			Установить
		</button>
	</div>
</div>

<script>
	const LATER_KEY = "aiz:pwa-install-later-at"
	const WEEK_MS = 7 * 24 * 60 * 60 * 1000

	const banner = document.getElementById("pwa-install-banner")
	const installBtn = document.getElementById("pwa-install")
	const laterBtn = document.getElementById("pwa-later")

	let deferredPrompt = null

	const isStandalone = () =>
		window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone

	const allowedByTimer = () => {
		const raw = localStorage.getItem(LATER_KEY)
		if (!raw) return true
		const ts = Number(raw)
		if (!Number.isFinite(ts)) return true
		return Date.now() - ts >= WEEK_MS
	}

	const showBanner = () => {
		if (!banner) return
		banner.classList.remove("hidden")
	}

	const hideBanner = () => {
		if (!banner) return
		banner.classList.add("hidden")
	}

	const maybeShowBanner = () => {
		if (!deferredPrompt) return
		if (isStandalone()) return
		if (!allowedByTimer()) return
		showBanner()
	}

	window.addEventListener("beforeinstallprompt", event => {
		event.preventDefault()
		deferredPrompt = event
		maybeShowBanner()
	})

	window.addEventListener("appinstalled", () => {
		hideBanner()
		deferredPrompt = null
		localStorage.removeItem(LATER_KEY)
	})

	laterBtn?.addEventListener("click", () => {
		localStorage.setItem(LATER_KEY, String(Date.now()))
		hideBanner()
	})

	installBtn?.addEventListener("click", async () => {
		if (!deferredPrompt) return
		deferredPrompt.prompt()
		await deferredPrompt.userChoice
		deferredPrompt = null
		hideBanner()
	})

	if ("serviceWorker" in navigator) {
		window.addEventListener("load", () => {
			navigator.serviceWorker.register("/sw.js")
		})
	}
</script>
